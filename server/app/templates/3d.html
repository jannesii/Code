{% extends 'base.html' %}

{% block title %}Sensor Dashboard{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/3d.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/flash.css') }}">
{% endblock %}
{% block content %}

<div class="container">
  <h1 class="demo-mode">DEMO-MODE</h1>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="flash-container" style="max-width:800px; margin:20px auto;">
      {% for category, msg in messages %}
      <div class="flash {{ category }}">
        {{ msg }}
      </div>
      {% endfor %}
    </div>
    {% endif %}
  {% endwith %}
  {% set _status = (last_status['status']|lower) if last_status else None %}
  {% set show_image = (_status != 'active') %}
  <div class="tile image-tile{% if show_image %} hidden{% endif %}" id="live-video">
    <video class="sensorImage" id="live" autoplay muted playsinline controls></video>
  </div>

  <!-- CAMERA SNAPSHOT -->
  <div class="tile image-tile{% if not show_image %} hidden{% endif %}" id="image">
    {% if last_image and last_image['image'] %}
      <img src="data:image/jpeg;base64,{{ last_image['image']|safe }}" class="sensorImage" alt="Sensor Image">
    {% else %}
      <img src="{{ url_for('static', filename='image-source2.png') }}" class="sensorImage" alt="Sensor Image">
    {% endif %}
  </div>
  <!-- ─── PRINT‑JOB PROGRESS BAR ───────────────────────────────────────── -->
  <div class="tile progress-tile" id="progressTile">
    <!-- top row: file name & % -->
    <div class="progress-header">
      <span id="fileName">–</span>
      <span id="progressPercent">0 %</span>
    </div>

    <!-- bar itself -->
    <div class="progress-container">
      <div class="progress-bar" id="progressBar" style="width:0%;"></div>
    </div>

    <!-- bottom row: extra stats -->
    <div class="progress-footer">
      <span id="layerInfo">Layer – / –</span>
      <span id="remainingTime">– : – : –</span>
      <span id="printSpeed">– mm/s</span>
    </div>
  </div>
  <!-- ─── PRINTER CONTROL BUTTONS ─────────────────────────────────────── -->
  <h2 class="section-title">Printer Control</h2>
  <div class="control-bar" id="controlBar">
    <button class="control-btn pause-btn"  data-action="pause">Pause</button>
    <button class="control-btn resume-btn" data-action="resume">Resume</button>
    <button class="control-btn stop-btn"   data-action="stop">Stop</button>
    <button class="control-btn home-btn"   data-action="home">Home</button>
  </div>
  <!-- ─── TIMELAPSE SECTION ────────────────────────────────────────────── -->
  <h2 class="section-title">Timelapse Control</h2>
  <div class="timelapse-bar" id="timelapseSwitch">
    <button class="control-btn start-btn" data-action="timelapse_start">Start</button>
    <button class="control-btn stop-btn" data-action="timelapse_stop">Stop</button>
  </div>
  <div class="timelapse-status-bar" id="timelapseStatus">
    {% if _status in ['active','inactive'] %}
      <button class="control-btn-status {{ 'start-btn' if _status == 'active' else 'stop-btn' }}">{{ 'Active' if _status == 'active' else 'Inactive' }}</button>
    {% else %}
      <button class="control-btn-status pause-btn">N/A</button>
    {% endif %}
  </div>

  <!-- ─── AMBIENT SECTION ──────────────────────────────────────────────── -->
  <h2 class="section-title">Ambient</h2>
  <div class="ambient-bar" id="ambientGrid">
    <div class="tile clickable" id="tempTile">
      Lämpötila<br><strong id="temperature">{{ last_temphum['temperature'] }} °C</strong>
    </div>
    <div class="tile clickable" id="humTile">
      Kosteus<br><strong id="humidity">{{ last_temphum['humidity'] }} %</strong>
    </div>
  </div>

  <!-- ─── PRINTER SECTION ──────────────────────────────────────────────── -->
  <h2 class="section-title">Printer</h2>
  <div class="data-grid" id="printerGrid">
    <div class="tile" id="bedTempTile">Bed<br><strong id="bedTemp">– °C</strong></div>
    <div class="tile" id="nozzleTempTile">Nozzle<br><strong id="nozzleTemp">– °C</strong></div>
    <div class="tile" id="nozzleTypeTile">Nozzle Type<br><strong id="nozzleType">–</strong></div>
    <div class="tile" id="nozzleDiamTile">Diameter<br><strong id="nozzleDiam">– mm</strong></div>
    <div class="tile status-tile" id="printerStatusTile">Status<br><strong id="printerStatus">–</strong></div>
    <div class="tile gcode-status-tile" id="gcodeStatusTile">G‑code<br><strong id="gcodeStatus">–</strong></div>
  </div>
</div>

<!-- ─── Run custom G‑code SECTION ────────────────────────────── -->
<h2 class="section-title">Run Custom G-code</h2>
<div class="gcode-tile">
  <textarea class="textarea" id="gcodeInput"
            placeholder="Enter G-code commands here…"></textarea>
  <button class="control-btn gcode-btn"
          id="runGcodeBtn" data-action="run_gcode">Run G-code</button>

  <ul id="gcodeSuggest" class="autocomplete-list"></ul>
</div>

{% include 'chart_modal.html' %}
{% endblock %}

{% block scripts %}
<script>
  // Expose initial status to client JS
  window.initialStatus = {{ (last_status or {}) | tojson | safe }};
  window.initialTemphum = {{ (last_temphum or {}) | tojson | safe }};
  window.initialImage = {{ (last_image or {}) | tojson | safe }};
  // Convenience flag: when false (inactive or unknown), prefer static image
  window.preferImage = !(window.initialStatus && typeof window.initialStatus.status === 'string' && window.initialStatus.status.toLowerCase() === 'active');
</script>
<script src="{{ url_for('static', filename='js/init_sio.js') }}"></script>
<script src="{{ url_for('static', filename='js/3d.js') }}"></script>
<script src="{{ url_for('static', filename='js/flash.js') }}"></script>
{% endblock %}
