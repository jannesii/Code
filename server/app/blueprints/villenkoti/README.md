# Villenkoti Subsystem

## API Endpoints

All routes live under the `villenkoti` blueprint prefix (`/villenkoti`), are protected by the Villenkoti API key store, and accept/return JSON.

### `POST /villenkoti/sensor_readings`

- Headers: `Authorization: Bearer <key>` or `X-API-Key: <key>`
- Payload:
  ```json
  {
    "location": "string",
    "temperature": 21.5,
    "humidity": 43.2,
  }
  ```
- Stores a timestamped reading in the local Villenkoti database and returns the autogenerated `reading_id`.

### `POST /villenkoti/execute_sql`

- Headers: same as above.
- Payload:
  ```json
  {
    "statement": "SQL statement",
    "params": [] | {} | null
  }
  ```
- Executes arbitrary SQL directly against the Villenkoti database. `SELECT` statements return rows while other statements return affected row counts + last insert id. Errors propagate as `sql_error`.

## Database Schema

Villenkoti keeps all data in a standalone SQLite file (`villenkoti.db` by default, overridable via `VILLENKOTI_DB_PATH` or CLI `--db-path`). The controller creates the tables and trigger automatically when it first opens the database.

### `api_keys`

| Column       | Type    | Description |
|--------------|---------|-------------|
| `id`         | INTEGER | Primary key. |
| `name`       | TEXT    | Friendly name for the key. |
| `secret_hash`| TEXT    | SHA-256 hash of the secret. |
| `created_at` | TEXT    | UTC timestamp of creation. |
| `created_by` | TEXT    | Optional actor identifier. |
| `last_used_at`| TEXT   | UTC timestamp of the last successful auth. |

### `sensor_readings`

| Column        | Type    | Description |
|---------------|---------|-------------|
| `id`          | INTEGER | Primary key. |
| `timestamp`   | TEXT    | UTC iso timestamp of the reading. |
| `location`    | TEXT    | Sensor location identifier. |
| `temperature` | REAL    | Temperature in °C. |
| `humidity`    | REAL    | Relative humidity in %. |

## Triggers

- `cleanup_sensor_readings_after_insert` — runs after each insert on `sensor_readings` and deletes rows older than 30 days so the table stays bounded.

